{% extends 'base.html.twig' %}

{% block title %}Music Page{% endblock %}

{% block body %}
    <h1>Music Page</h1>
    <button id="play-button">Play track</button>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        window.onSpotifyWebPlaybackSDKReady = () => {
            const token = sessionStorage.getItem('spotifyAccessToken');
            if (token) {
                const playSpotifyTrack = async (spotifyUri) => {
                    if (window.Spotify) {
                        const { Player } = Spotify;

                        const player = new Player({
                            name: 'Flopify Web Player',
                            getOAuthToken: (cb) => { cb(token); }
                        });

                        player.addListener('ready', ({ device_id }) => {
                            console.log('Ready with Device ID', device_id);

                            // Lecture de la piste
                            fetch(`https://api.spotify.com/v1/me/player/play?device_id=${device_id}`, {
                                method: 'PUT',
                                body: JSON.stringify({ uris: [spotifyUri] }),
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                            });
                        });

                        player.connect();
                    } else {
                        console.error('Spotify SDK not loaded');
                    }
                };

                document.getElementById('play-button').addEventListener('click', () => {
                    const spotifyUri = 'spotify:track:5nTtCOCds6I0PHMNtqelas'; // Remplacez par l'URI de votre choix
                    playSpotifyTrack(spotifyUri);
                });
            } else {
                console.error('No access token found in sessionStorage');
            }
        };
    </script>
{% endblock %}
